{{define "pre_enrolment_detail_content"}}
<!-- Header -->
<div class="header">
    <img src="/static/logo/eighty-twenty-logo.png" alt="Eighty Twenty" class="app-logo" />
    <h1>Pre-Enrolment Detail</h1>
</div>

{{if .IsModerator}}
<div style="background-color: #FFF4E6; border: 1px solid #FFD700; border-left: 4px solid #FFA500; padding: 15px; margin-bottom: 20px; border-radius: 4px;">
    <strong>Read-Only Mode:</strong> As a moderator, you can view lead details but cannot make changes.
</div>
{{end}}

<!-- Main form for full edit - uses single endpoint with action parameter -->
<form method="POST" action="/pre-enrolment/{{.Detail.Lead.ID}}" id="pre-enrolment-form">
    <input type="hidden" name="status" value="{{.Detail.Lead.Status}}">
    
    <!-- 1. Lead Info -->
    <div class="form-section">
        <h2>Lead Info</h2>
        <div class="section-note">Moderator: Fills this section when creating the lead</div>
        
        <div class="form-group">
            <label for="full_name">Full Name *</label>
            <input type="text" id="full_name" name="full_name" value="{{.Detail.Lead.FullName}}" {{if .IsModerator}}readonly{{else}}required{{end}}>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="phone">Phone Number *</label>
                <input type="tel" id="phone" name="phone" value="{{.Detail.Lead.Phone}}" {{if .IsModerator}}readonly{{else}}required{{end}}>
            </div>
            <div class="form-group">
                <label for="source">Source</label>
                <select id="source" name="source" {{if .IsModerator}}disabled{{end}}>
                    <option value="Facebook" {{if or (not .Detail.Lead.Source.Valid) (eq .Detail.Lead.Source.String "Facebook")}}selected{{end}}>Facebook</option>
                    <option value="WhatsApp" {{if and .Detail.Lead.Source.Valid (eq .Detail.Lead.Source.String "WhatsApp")}}selected{{end}}>WhatsApp</option>
                    <option value="Instagram" {{if and .Detail.Lead.Source.Valid (eq .Detail.Lead.Source.String "Instagram")}}selected{{end}}>Instagram</option>
                    <option value="Referral" {{if and .Detail.Lead.Source.Valid (eq .Detail.Lead.Source.String "Referral")}}selected{{end}}>Referral</option>
                    <option value="Walk-in" {{if and .Detail.Lead.Source.Valid (eq .Detail.Lead.Source.String "Walk-in")}}selected{{end}}>Walk-in</option>
                    <option value="Other" {{if and .Detail.Lead.Source.Valid (eq .Detail.Lead.Source.String "Other")}}selected{{end}}>Other</option>
                </select>
            </div>
        </div>
        
        <div class="form-group">
            <label for="notes">Notes</label>
            <textarea id="notes" name="notes" placeholder="Internal notes about this lead..." {{if .IsModerator}}readonly{{end}}>{{if .Detail.Lead.Notes.Valid}}{{.Detail.Lead.Notes.String}}{{end}}</textarea>
        </div>
    </div>

    <!-- 2. Placement Test -->
    <div class="form-section">
        <h2>Placement Test</h2>
        <div class="section-note">Admin: Books test | Community Officer: Assigns level and test notes</div>
        
        <!-- Placement Test Fee (admin can edit) -->
        {{if not .IsModerator}}
        <div style="background: #FFF4E6; padding: 15px; border-radius: 4px; margin-bottom: 20px; border: 1px solid #FFD700;">
            <h3 style="margin-top: 0; font-size: 16px;">Placement Test Fee</h3>
            <div class="form-row">
                <div class="form-group">
                    <label for="placement_test_fee">Fee (EGP)</label>
                    <input type="number" id="placement_test_fee" name="placement_test_fee" min="0" value="{{if and .Detail.PlacementTest .Detail.PlacementTest.PlacementTestFee.Valid}}{{.Detail.PlacementTest.PlacementTestFee.Int32}}{{else}}100{{end}}" form="pre-enrolment-form">
                </div>
                <div class="form-group">
                    <label for="placement_test_fee_paid">Paid (EGP)</label>
                    <input type="number" id="placement_test_fee_paid" name="placement_test_fee_paid" min="0" value="{{if and .Detail.PlacementTest .Detail.PlacementTest.PlacementTestFeePaid.Valid}}{{.Detail.PlacementTest.PlacementTestFeePaid.Int32}}{{else}}0{{end}}" form="pre-enrolment-form">
                </div>
                <div class="form-group">
                    <label>Remaining (EGP)</label>
                    <input type="text" id="placement_test_remaining" readonly style="background: #F0F0F0;" value="">
                </div>
            </div>
        </div>
        {{else}}
        <!-- Read-only fee display for moderators -->
        <div style="background: #F9F9F9; padding: 15px; border-radius: 4px; margin-bottom: 20px; border: 1px solid #E6E6E6;">
            <h3 style="margin-top: 0; font-size: 16px;">Placement Test Fee</h3>
            <p><strong>Fee:</strong> {{if and .Detail.PlacementTest .Detail.PlacementTest.PlacementTestFee.Valid}}{{.Detail.PlacementTest.PlacementTestFee.Int32}}{{else}}100{{end}} EGP</p>
            <p><strong>Paid:</strong> {{if and .Detail.PlacementTest .Detail.PlacementTest.PlacementTestFeePaid.Valid}}{{.Detail.PlacementTest.PlacementTestFeePaid.Int32}}{{else}}0{{end}} EGP</p>
            <p><strong>Remaining:</strong> <span id="moderator_placement_test_remaining">{{.PlacementTestRemaining}}</span> EGP</p>
        </div>
        {{end}}
        
        <!-- Full placement test form (for main form) -->
        <div class="form-row">
            <div class="form-group">
                <label for="test_date">Test Date</label>
                <input type="date" id="test_date" name="test_date" value="{{if and .Detail.PlacementTest .Detail.PlacementTest.TestDate.Valid}}{{.Detail.PlacementTest.TestDate.Time.Format "2006-01-02"}}{{end}}" {{if .IsModerator}}readonly{{end}}>
            </div>
            <div class="form-group">
                <label for="test_time">Test Time</label>
                <input type="time" id="test_time" name="test_time" value="{{if and .Detail.PlacementTest .Detail.PlacementTest.TestTime.Valid}}{{.Detail.PlacementTest.TestTime.String}}{{end}}" {{if .IsModerator}}readonly{{end}}>
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="test_type">Test Type</label>
                <select id="test_type" name="test_type" {{if .IsModerator}}disabled{{end}}>
                    <option value="online" {{if and .Detail.PlacementTest .Detail.PlacementTest.TestType.Valid}}{{if eq .Detail.PlacementTest.TestType.String "online"}}selected{{end}}{{end}}>Online</option>
                    <option value="live" {{if and .Detail.PlacementTest .Detail.PlacementTest.TestType.Valid}}{{if eq .Detail.PlacementTest.TestType.String "live"}}selected{{end}}{{else}}selected{{end}}>Live</option>
                </select>
            </div>
            <div class="form-group">
                <label for="assigned_level">Assigned Level</label>
                <select id="assigned_level" name="assigned_level" {{if .IsModerator}}disabled{{end}}>
                    <option value="">Not tested yet</option>
                    <option value="1" {{if and .Detail.PlacementTest .Detail.PlacementTest.AssignedLevel.Valid}}{{if eq .Detail.PlacementTest.AssignedLevel.Int32 1}}selected{{end}}{{end}}>Level 1</option>
                    <option value="2" {{if and .Detail.PlacementTest .Detail.PlacementTest.AssignedLevel.Valid}}{{if eq .Detail.PlacementTest.AssignedLevel.Int32 2}}selected{{end}}{{end}}>Level 2</option>
                    <option value="3" {{if and .Detail.PlacementTest .Detail.PlacementTest.AssignedLevel.Valid}}{{if eq .Detail.PlacementTest.AssignedLevel.Int32 3}}selected{{end}}{{end}}>Level 3</option>
                    <option value="4" {{if and .Detail.PlacementTest .Detail.PlacementTest.AssignedLevel.Valid}}{{if eq .Detail.PlacementTest.AssignedLevel.Int32 4}}selected{{end}}{{end}}>Level 4</option>
                </select>
            </div>
        </div>
        
        <div class="form-group">
            <label for="test_notes">Test Notes</label>
            <textarea id="test_notes" name="test_notes" placeholder="Community Officer: Add test results and observations..." {{if .IsModerator}}readonly{{end}}>{{if and .Detail.PlacementTest .Detail.PlacementTest.TestNotes.Valid}}{{.Detail.PlacementTest.TestNotes.String}}{{end}}</textarea>
        </div>
    </div>

    <!-- 3. Offer & Pricing -->
    <div class="form-section">
        <h2>Offer & Pricing</h2>
        <div class="section-note">Admin: Sets pricing and sends offer</div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="bundle">Bundle Selected</label>
                <select id="bundle" name="bundle">
                    <option value="1" {{if and .Detail.Offer .Detail.Offer.BundleLevels.Valid}}{{if eq .Detail.Offer.BundleLevels.Int32 1}}selected{{end}}{{end}}>Bundle 1</option>
                    <option value="2" {{if and .Detail.Offer .Detail.Offer.BundleLevels.Valid}}{{if eq .Detail.Offer.BundleLevels.Int32 2}}selected{{end}}{{else}}selected{{end}}>Bundle 2</option>
                    <option value="3" {{if and .Detail.Offer .Detail.Offer.BundleLevels.Valid}}{{if eq .Detail.Offer.BundleLevels.Int32 3}}selected{{end}}{{end}}>Bundle 3</option>
                    <option value="4" {{if and .Detail.Offer .Detail.Offer.BundleLevels.Valid}}{{if eq .Detail.Offer.BundleLevels.Int32 4}}selected{{end}}{{end}}>Bundle 4</option>
                </select>
            </div>
            <div class="form-group">
                <label for="base_price">Base Price</label>
                <input type="number" id="base_price" name="base_price" value="{{if and .Detail.Offer .Detail.Offer.BasePrice.Valid}}{{.Detail.Offer.BasePrice.Int32}}{{end}}" step="1">
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="discount">Discount (Amount or %)</label>
                <input type="text" id="discount" name="discount" value="{{if and .Detail.Offer .Detail.Offer.DiscountValue.Valid}}{{.Detail.Offer.DiscountValue.Int32}}{{if and .Detail.Offer .Detail.Offer.DiscountType.Valid}}{{if eq .Detail.Offer.DiscountType.String "percent"}}%{{end}}{{end}}{{end}}" placeholder="e.g., 500 or 10%">
            </div>
            <div class="form-group">
                <label for="final_price">Final Price</label>
                <input type="number" id="final_price" name="final_price" value="{{if and .Detail.Offer .Detail.Offer.FinalPrice.Valid}}{{.Detail.Offer.FinalPrice.Int32}}{{end}}" step="1">
            </div>
        </div>
        
        <div class="form-group">
            <label>Status</label>
            <span class="status-indicator {{.Detail.Lead.Status}}">{{.Detail.Lead.Status}}</span>
        </div>
    </div>

    <!-- 4. Booking & Materials -->
    <div class="form-section">
        <h2>Booking & Materials</h2>
        <div class="section-note">Admin: Handles booking format and delivery</div>
        
        <div class="form-group">
            <label for="book_format">Book Format</label>
            <select id="book_format" name="book_format" onchange="togglePrintedFields()">
                <option value="pdf" {{if and .Detail.Booking .Detail.Booking.BookFormat.Valid}}{{if eq .Detail.Booking.BookFormat.String "pdf"}}selected{{end}}{{end}}>PDF</option>
                <option value="printed" {{if and .Detail.Booking .Detail.Booking.BookFormat.Valid}}{{if eq .Detail.Booking.BookFormat.String "printed"}}selected{{end}}{{else}}selected{{end}}>Printed</option>
            </select>
        </div>
        
        <div id="printed-fields">
            <div class="form-group">
                <label for="address">Address</label>
                <input type="text" id="address" name="address" value="{{if and .Detail.Booking .Detail.Booking.Address.Valid}}{{.Detail.Booking.Address.String}}{{end}}">
            </div>
            
            <div class="form-group">
                <label for="city">City</label>
                <input type="text" id="city" name="city" value="{{if and .Detail.Booking .Detail.Booking.City.Valid}}{{.Detail.Booking.City.String}}{{end}}">
            </div>
            
            <div class="form-group">
                <label for="delivery_notes">Delivery Notes</label>
                <textarea id="delivery_notes" name="delivery_notes" placeholder="Special delivery instructions...">{{if and .Detail.Booking .Detail.Booking.DeliveryNotes.Valid}}{{.Detail.Booking.DeliveryNotes.String}}{{end}}</textarea>
            </div>
        </div>
    </div>

    <!-- 5. Payment -->
    <div class="form-section">
        <h2>Payment</h2>
        <div class="section-note">Admin: Records payment information</div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="payment_type">Payment Type</label>
                <select id="payment_type" name="payment_type">
                    <option value="">Not paid</option>
                    <option value="full" {{if and .Detail.Payment .Detail.Payment.PaymentType.Valid}}{{if eq .Detail.Payment.PaymentType.String "full"}}selected{{end}}{{end}}>Full Payment</option>
                    <option value="deposit" {{if and .Detail.Payment .Detail.Payment.PaymentType.Valid}}{{if eq .Detail.Payment.PaymentType.String "deposit"}}selected{{end}}{{end}}>Deposit</option>
                </select>
            </div>
            <div class="form-group">
                <label for="payment_date">Payment Date</label>
                <input type="date" id="payment_date" name="payment_date" value="{{if and .Detail.Payment .Detail.Payment.PaymentDate.Valid}}{{.Detail.Payment.PaymentDate.Time.Format "2006-01-02"}}{{end}}">
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="amount_paid">Amount Paid</label>
                <input type="number" id="amount_paid" name="amount_paid" value="{{if and .Detail.Payment .Detail.Payment.AmountPaid.Valid}}{{.Detail.Payment.AmountPaid.Int32}}{{end}}" step="1">
            </div>
            <div class="form-group">
                <label for="remaining_balance">Remaining Balance</label>
                <input type="number" id="remaining_balance" name="remaining_balance" value="{{if and .Detail.Payment .Detail.Payment.RemainingBalance.Valid}}{{.Detail.Payment.RemainingBalance.Int32}}{{end}}" step="1" readonly>
            </div>
        </div>
        
        {{if and .Detail.Payment .Detail.Payment.RemainingBalance.Valid}}{{if gt .Detail.Payment.RemainingBalance.Int32 0}}
        <div class="warning-box" id="payment-warning">
            <strong>⚠️ Financial Block:</strong> Student is financially blocked from starting. Remaining balance: {{.Detail.Payment.RemainingBalance.Int32}} EGP
        </div>
        {{end}}{{end}}
    </div>

    <!-- 6. Round / Schedule -->
    <div class="form-section">
        <h2>Round / Schedule</h2>
        <div class="section-note">Admin: Assigns schedule when student is ready</div>
        
        <div class="form-group">
            <label for="expected_round">Expected Round</label>
            <input type="text" id="expected_round" name="expected_round" value="{{if and .Detail.Scheduling .Detail.Scheduling.ExpectedRound.Valid}}{{.Detail.Scheduling.ExpectedRound.String}}{{end}}" placeholder="e.g., Round 3 - February 2026">
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="class_days">Class Days</label>
                <input type="text" id="class_days" name="class_days" value="{{if and .Detail.Scheduling .Detail.Scheduling.ClassDays.Valid}}{{.Detail.Scheduling.ClassDays.String}}{{end}}" placeholder="e.g., Monday, Wednesday">
            </div>
            <div class="form-group">
                <label for="class_time">Class Time</label>
                <input type="time" id="class_time" name="class_time" value="{{if and .Detail.Scheduling .Detail.Scheduling.ClassTime.Valid}}{{.Detail.Scheduling.ClassTime.String}}{{end}}">
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="start_date">Start Date</label>
                <input type="date" id="start_date" name="start_date" value="{{if and .Detail.Scheduling .Detail.Scheduling.StartDate.Valid}}{{.Detail.Scheduling.StartDate.Time.Format "2006-01-02"}}{{end}}">
            </div>
            <div class="form-group">
                <label for="start_time">Start Time</label>
                <input type="time" id="start_time" name="start_time" value="{{if and .Detail.Scheduling .Detail.Scheduling.StartTime.Valid}}{{.Detail.Scheduling.StartTime.String}}{{end}}">
            </div>
        </div>
        
        <div class="form-group">
            <label>Status</label>
            <span class="badge {{.Detail.Lead.Status}}">{{.Detail.Lead.Status}}</span>
        </div>
    </div>

    <!-- 7. Shipping (Printed only) -->
    {{if and .Detail.Booking .Detail.Booking.BookFormat.Valid}}{{if eq .Detail.Booking.BookFormat.String "printed"}}
    <div class="form-section" id="shipping-section">
        <h2>Shipping</h2>
        <div class="section-note">Admin: Tracks shipment for printed books</div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="shipment_status">Shipment Status</label>
                <select id="shipment_status" name="shipment_status">
                    <option value="pending" {{if and .Detail.Shipping .Detail.Shipping.ShipmentStatus.Valid}}{{if eq .Detail.Shipping.ShipmentStatus.String "pending"}}selected{{end}}{{else}}selected{{end}}>Pending</option>
                    <option value="sent" {{if and .Detail.Shipping .Detail.Shipping.ShipmentStatus.Valid}}{{if eq .Detail.Shipping.ShipmentStatus.String "sent"}}selected{{end}}{{end}}>Sent</option>
                    <option value="delivered" {{if and .Detail.Shipping .Detail.Shipping.ShipmentStatus.Valid}}{{if eq .Detail.Shipping.ShipmentStatus.String "delivered"}}selected{{end}}{{end}}>Delivered</option>
                </select>
            </div>
            <div class="form-group">
                <label for="shipment_date">Shipment Date</label>
                <input type="date" id="shipment_date" name="shipment_date" value="{{if and .Detail.Shipping .Detail.Shipping.ShipmentDate.Valid}}{{.Detail.Shipping.ShipmentDate.Time.Format "2006-01-02"}}{{end}}">
            </div>
        </div>
    </div>
    {{end}}{{end}}

    <!-- Action Buttons - All use single form with action parameter -->
    {{if not .IsModerator}}
    <div class="action-buttons" style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #E6E6E6;">
        <button type="submit" form="pre-enrolment-form" name="action" value="save" class="btn btn-primary">Save</button>
        <button type="submit" form="pre-enrolment-form" name="action" value="mark_test_booked" class="btn btn-secondary">Mark Test Booked</button>
        <button type="submit" form="pre-enrolment-form" name="action" value="mark_tested" class="btn btn-secondary">Mark Tested</button>
        <button type="submit" form="pre-enrolment-form" name="action" value="mark_offer_sent" class="btn btn-secondary">Mark Offer Sent</button>
        <button type="submit" form="pre-enrolment-form" name="action" value="move_waiting" class="btn btn-secondary">Move to Waiting List</button>
        <button type="submit" form="pre-enrolment-form" name="action" value="mark_ready" class="btn btn-secondary">Mark Ready to Start</button>
    </div>
    
    <!-- Delete Button -->
    {{if .ShowDeleteConfirm}}
    <div style="margin-top: 30px; padding: 20px; background-color: #FFF4E6; border: 2px solid #FFA500; border-radius: 4px;">
        <h3 style="margin-top: 0; color: #CC6600;">⚠️ Confirm Deletion</h3>
        <p>Are you sure you want to delete <strong>{{.Detail.Lead.FullName}}</strong>? This action cannot be undone.</p>
        <form method="POST" action="/pre-enrolment/{{.Detail.Lead.ID}}" style="display: inline-block;">
            <input type="hidden" name="action" value="delete">
            <input type="hidden" name="confirm_delete" value="yes">
            <button type="submit" class="btn" style="background-color: #dc3545; border-color: #dc3545; color: white;">Yes, Delete Lead</button>
            <a href="/pre-enrolment/{{.Detail.Lead.ID}}" class="btn btn-secondary" style="margin-left: 10px;">Cancel</a>
        </form>
    </div>
    {{else}}
    <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #E6E6E6;">
        <form method="POST" action="/pre-enrolment/{{.Detail.Lead.ID}}" style="display: inline-block;">
            <input type="hidden" name="action" value="delete">
            <button type="submit" class="btn" style="background-color: #dc3545; border-color: #dc3545; color: white;">Delete Lead</button>
        </form>
    </div>
    {{end}}
    {{end}}
</form>

<script>
    function togglePrintedFields() {
        const bookFormat = document.getElementById('book_format').value;
        const printedFields = document.getElementById('printed-fields');
        const shippingSection = document.getElementById('shipping-section');
        
        if (bookFormat === 'printed') {
            if (printedFields) printedFields.style.display = 'block';
            if (shippingSection) shippingSection.style.display = 'block';
        } else {
            if (printedFields) printedFields.style.display = 'none';
            if (shippingSection) shippingSection.style.display = 'none';
        }
    }

    function calculatePlacementTestRemaining() {
        const feeInput = document.getElementById('placement_test_fee');
        const paidInput = document.getElementById('placement_test_fee_paid');
        const remainingInput = document.getElementById('placement_test_remaining');
        
        if (feeInput && paidInput && remainingInput) {
            const fee = parseInt(feeInput.value) || 0;
            const paid = parseInt(paidInput.value) || 0;
            const remaining = Math.max(0, fee - paid);
            remainingInput.value = remaining;
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        togglePrintedFields();
        
        // Calculate placement test remaining fee
        const feeInput = document.getElementById('placement_test_fee');
        const paidInput = document.getElementById('placement_test_fee_paid');
        if (feeInput && paidInput) {
            calculatePlacementTestRemaining();
            feeInput.addEventListener('input', calculatePlacementTestRemaining);
            paidInput.addEventListener('input', calculatePlacementTestRemaining);
        }
        
        // Disable all form inputs for moderators (read-only mode)
        {{if .IsModerator}}
        const form = document.getElementById('pre-enrolment-form');
        if (form) {
            const inputs = form.querySelectorAll('input, select, textarea');
            inputs.forEach(function(input) {
                input.disabled = true;
            });
        }
        {{end}}
    });
</script>
{{end}}
